version: '3.8'

services:
  # --- NEXT.JS DASHBOARD (DEV MODE) ---
  mediamtx-dashboard:
    container_name: mediamtx-dashboard-dev
    image: node:20-slim
    working_dir: /app
    volumes:
      - .:/app
      # This anonymous volume prevents Windows node_modules from 
      # overwriting the Linux ones we install inside the container
      - /app/node_modules
    environment:
      - NEXT_PUBLIC_MEDIAMTX_API_URL=http://localhost:9997
      - NODE_ENV=development
    # This command installs the tools, fixes links, and starts the dev server
    command: >
      sh -c "npm install -g pnpm && pnpm install && pnpm dev"
    ports:
      - "3000:3000"
    networks:
      - mediamtx-net
    restart: unless-stopped

  # --- NGINX PROXY (DEV MODE) ---
  mediamtx-proxy:
    container_name: mediamtx-proxy-dev
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - mediamtx-dashboard
    networks:
      - mediamtx-net
    restart: unless-stopped

networks:
  mediamtx-net:
    driver: bridge